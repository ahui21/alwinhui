<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8">
  <title>Map Visualization</title>
  <script src="https://d3js.org/d3.v6.min.js"></script>
  <script src="https://d3js.org/d3-geo.v2.min.js"></script>
  <script src="https://unpkg.com/topojson@3"></script>
  <style>
    #tooltip {
      position: absolute;
      background-color: white;
      padding: 10px;
      border: 1px solid #ccc;
      opacity: 0;
      pointer-events: none;
    }
  </style>
</head>
<body>
  <div id="map"></div>
  <div id="filter">
    <label for="hazard-select">Hazard:</label>
    <select id="hazard-select"></select>
    <label for="probability-select">Current Probability:</label>
    <select id="probability-select"></select>
    <label for="magnitude-select">Current Magnitude:</label>
    <select id="magnitude-select"></select>
    <label for="intensity-select">Expected Change in Intensity:</label>
    <select id="intensity-select"></select>
    <label for="frequency-select">Expected Change in Frequency:</label>
    <select id="frequency-select"></select>
  </div>
  <div id="tooltip"></div>

  <script>
    // Load the data from the CSV file
    d3.csv("http://alwinhui.com/CS448-Final-Project/data.csv").then(function(data) {
	  // Create the filter interface options
  var hazardOptions = ["All"];
  var probabilityOptions = ["All"];
  var magnitudeOptions = ["All"];
  var intensityOptions = ["All"];
  var frequencyOptions = ["All"];
  
  data.forEach(function(d) {
    if (!hazardOptions.includes(d["Climate-related hazards"])) {
      hazardOptions.push(d["Climate-related hazards"]);
    }
    if (!probabilityOptions.includes(d["Current probability of hazard"])) {
      probabilityOptions.push(d["Current probability of hazard"]);
    }
    if (!magnitudeOptions.includes(d["Current magnitude of impact of hazard"])) {
      magnitudeOptions.push(d["Current magnitude of impact of hazard"]);
    }
    if (!intensityOptions.includes(d["Expected future change in hazard intensity"])) {
      intensityOptions.push(d["Expected future change in hazard intensity"]);
    }
    if (!frequencyOptions.includes(d["Expected future change in hazard frequency"])) {
      frequencyOptions.push(d["Expected future change in hazard frequency"]);
    }
  });
  
  var hazardSelect = d3.select("#hazard-select")
    .selectAll("option")
    .data(hazardOptions)
    .enter()
    .append("option")
    .text(function(d) { return d; });
  
  var probabilitySelect = d3.select("#probability-select")
    .selectAll("option")
    .data(probabilityOptions)
    .enter()
    .append("option")
    .text(function(d) { return d; });
  
  var magnitudeSelect = d3.select("#magnitude-select")
    .selectAll("option")
    .data(magnitudeOptions)
    .enter()
    .append("option")
    .text(function(d) { return d; });

  var intensitySelect = d3.select("#intensity-select")
    .selectAll("option")
    .data(intensityOptions)
    .enter()
    .append("option")
    .text(function(d) { return d; });

  var frequencySelect = d3.select("#frequency-select")
    .selectAll("option")
    .data(frequencyOptions)
    .enter()
    .append("option")
    .text(function(d) { return d; });

// Create the map using D3.js
var width = 960;
var height = 500;

var svg = d3.select("#map")
.append("svg")
.attr("width", width)
.attr("height", height);

var projection = d3.geoMercator()
.scale(130)
.translate([width / 2, height / 1.5]);

var path = d3.geoPath().projection(projection);

d3.json("https://cdn.jsdelivr.net/npm/world-atlas@2/land-50m.json").then(function(world) {

svg.append("path")
  .datum(topojson.feature(world, world.objects.land))
  .attr("d", path)
  .attr("fill", "#f5f5f5")
  .attr("stroke", "#666");

var circles = svg.selectAll("circle")
  .data(data)
  .enter()
  .append("circle")
  .attr("cx", function(d) {
    var location = d["City Location"].split(",");
    return projection([+location[1], +location[0]])[0];
  })
  .attr("cy", function(d) {
    var location = d["City Location"].split(",");
    return projection([+location[1], +location[0]])[1];
  })
  .attr("r", 5)
  .attr("fill", "steelblue")
  .attr("opacity", 0.7)
 .on("mouseover", function(event, d) {
  d3.select(this)
    .transition()
    .duration(200)
    .attr("r", 10);
  var [pageX, pageY] = d3.pointer(event);
  var tooltip = d3.select("#tooltip")
    .style("left", (pageX + 10) + "px")
    .style("top", (pageY - 10) + "px")
    .style("opacity", 0.9);
	tooltip.html(""); // clear the tooltip content
    tooltip.append("p").html("<strong>City:</strong> " + d.City);
    tooltip.append("p").html("<strong>Country:</strong> " + d.Country);
    tooltip.append("p").html("<strong>Hazard:</strong> " + d["Climate-related hazards"]);
    tooltip.append("p").html("<strong>Current Probability:</strong> " + d["Current probability of hazard"]);
    tooltip.append("p").html("<strong>Current Magnitude:</strong> " + d["Current magnitude of impact of hazard"]);
    tooltip.append("p").html("<strong>Expected Change in Intensity:</strong> " + d["Expected future change in hazard intensity"]);
    tooltip.append("p").html("<strong>Expected Change in Frequency:</strong> " + d["Expected future change in hazard frequency"]);
  })
.on("mouseout", function(event, d) {
  d3.select(this)
    .transition()
    .duration(200)
    .attr("r", 5);
  d3.select("#tooltip")
    .style("opacity", 0);
});

// Filter the data based on the filter interface selections
function updateData() {
  var filteredData = data.filter(function(d) {
    var hazardFilter = d3.select("#hazard-select").node().value;
    var probabilityFilter = d3.select("#probability-select").node().value;
    var magnitudeFilter = d3.select("#magnitude-select").node().value;
    var intensityFilter = d3.select("#intensity-select").node().value;
    var frequencyFilter = d3.select("#frequency-select").node().value;
    return (hazardFilter === "All" || d["Climate-related hazards"] === hazardFilter) &&
(probabilityFilter === "All" || d["Current probability of hazard"] === probabilityFilter) &&
(magnitudeFilter === "All" || d["Current magnitude of impact of hazard"] === magnitudeFilter) &&
(intensityFilter === "All" || d["Expected future change in hazard intensity"] === intensityFilter) &&
(frequencyFilter === "All" || d["Expected future change in hazard frequency"] === frequencyFilter);
});

  // Update the circles on the map based on the filtered data
  circles.data(filteredData)
    .attr("cx", function(d) {
      var location = d["City Location"].split(",");
      return projection([+location[1], +location[0]])[0];
    })
    .attr("cy", function(d) {
      var location = d["City Location"].split(",");
      return projection([+location[1], +location[0]])[1];
    })
    .attr("fill", "steelblue")
    .attr("opacity", 0.7);
}

// Call the updateData function whenever a filter is changed
d3.select("#hazard-select").on("change", updateData);
d3.select("#probability-select").on("change", updateData);
d3.select("#magnitude-select").on("change", updateData);
d3.select("#intensity-select").on("change", updateData);
d3.select("#frequency-select").on("change", updateData);
});
});


</script>
